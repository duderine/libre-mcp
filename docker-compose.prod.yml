# Production Environment - SSL, Security Headers, & High Availability
# Usage: docker compose -f docker-compose.prod.yml up -d

services:
  # --- INFRASTRUCTURE (Traefik with SSL) ---
  traefik:
    extends:
      file: docker-compose.traefik.yml
      service: traefik
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=${TRAEFIK_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--accesslog=true"
    volumes:
      - ./letsencrypt:/letsencrypt

  # --- LIBRECHAT ---
  mongodb:
    extends: { file: docker-compose.librechat.yml, service: mongodb }
    restart: always

  meilisearch:
    extends: { file: docker-compose.librechat.yml, service: meilisearch }
    restart: always

  api:
    extends: { file: docker-compose.librechat.yml, service: api }
    restart: always
    labels:
      - "traefik.http.routers.librechat-secure.tls.certresolver=letsencrypt"

  # --- WEBUI ---
  openwebui:
    extends: { file: docker-compose.openwebui.yml, service: openwebui }
    restart: always
    labels:
      - "traefik.http.routers.openwebui-secure.tls.certresolver=letsencrypt"

  # --- WEBSEARCH ---
  searxng:
    extends: { file: docker-compose.websearch.yml, service: searxng }
    restart: always
    labels:
      - "traefik.http.routers.searxng-secure.tls.certresolver=letsencrypt"

  firecrawl-api:
    extends: { file: docker-compose.websearch.yml, service: firecrawl-api }
    restart: always
    labels:
      - "traefik.http.routers.firecrawl-secure.tls.certresolver=letsencrypt"

  playwright-service:
    extends: { file: docker-compose.websearch.yml, service: playwright-service }
    restart: always

  redis:
    extends: { file: docker-compose.websearch.yml, service: redis }
    restart: always

  nuq-postgres:
    extends: { file: docker-compose.websearch.yml, service: nuq-postgres }
    restart: always

  # --- RAG ---
  vectordb:
    extends: { file: docker-compose.rag.yml, service: vectordb }
    restart: always

  rag_api:
    extends: { file: docker-compose.rag.yml, service: rag_api }
    restart: always

networks:
  traefik-net:
    external: true
  firecrawl-network:
    driver: bridge

volumes:
  firecrawl_pgdata:
  pgdata2:
