name: ai-chat-interface
networks:
  firecrawl-network:
    driver: bridge
    name: ai-chat-interface_firecrawl-network
  traefik-net:
    external: true
    name: loadbalancer-net
services:
  api:
    container_name: LibreChat
    depends_on:
      meilisearch:
        condition: service_started
        required: true
      mongodb:
        condition: service_started
        required: true
    environment:
      ALLOW_REGISTRATION: ${LIBRECHAT_ALLOW_REGISTRATION:-true}
      CREDS_IV: ${LIBRECHAT_CREDS_IV}
      CREDS_KEY: ${LIBRECHAT_CREDS_KEY}
      HOST: ${LIBRECHAT_HOST:-0.0.0.0}
      JWT_REFRESH_SECRET: ${LIBRECHAT_JWT_REFRESH_SECRET}
      JWT_SECRET: ${LIBRECHAT_JWT_SECRET}
      MEILI_HOST: ${LIBRECHAT_MEILI_HOST:-http://meilisearch:7700}
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
      MONGO_URI: ${LIBRECHAT_MONGO_URI}
      OPENROUTER_APP_NAME: ${OPENROUTER_APP_NAME}
      OPENROUTER_BASE_URL: ${OPENROUTER_BASE_URL}
      OPENROUTER_KEY: ${OPENROUTER_API_KEY}
      OPENROUTER_SITE_URL: http://chat.${DOMAIN:-localhost}
      RAG_API_URL: ${LIBRECHAT_RAG_API_URL:-http://rag_api:8000}
      RAG_PORT: ${LIBRECHAT_RAG_PORT:-8000}
      SEARCH: "true"
      SEARXNG_BASE_URL: http://searxng.${DOMAIN:-localhost}/
      SESSION_SECRET: ${LIBRECHAT_SESSION_SECRET}
    extra_hosts:
      - host.docker.internal:host-gateway
    image: ghcr.io/danny-avila/librechat-dev:latest
    labels:
      - traefik.enable=true
      - traefik.http.routers.librechat.rule=Host(`chat.${DOMAIN:-localhost}`)
      - traefik.http.routers.librechat.entrypoints=web
      - traefik.http.services.librechat.loadbalancer.server.port=3080
      - traefik.http.routers.librechat-secure.rule=Host(`chat.${DOMAIN:-localhost}`)
      - traefik.http.routers.librechat-secure.entrypoints=websecure
      - traefik.http.routers.librechat-secure.tls=true
      - traefik.http.routers.librechat-secure.tls.certresolver=le
    networks:
      traefik-net: null
    restart: always
    user: ${UID:-1000}:${GID:-1000}
    volumes:
      - source: /home/jumplink/Projekte/faktenforum/ai-chat-interface/.env
        target: /app/.env
        type: bind
      - bind:
          create_host_path: true
        source: /home/jumplink/Projekte/faktenforum/ai-chat-interface/images
        target: /app/client/public/images
        type: bind
      - bind:
          create_host_path: true
        source: /home/jumplink/Projekte/faktenforum/ai-chat-interface/uploads
        target: /app/uploads
        type: bind
      - bind:
          create_host_path: true
        source: /home/jumplink/Projekte/faktenforum/ai-chat-interface/logs
        target: /app/logs
        type: bind
      - source: /home/jumplink/Projekte/faktenforum/ai-chat-interface/librechat.yaml
        target: /app/librechat.yaml
        type: bind
  firecrawl-api:
    command:
      - node
      - dist/src/harness.js
      - --start-docker
    container_name: firecrawl-api
    depends_on:
      nuq-postgres:
        condition: service_healthy
        required: true
      playwright-service:
        condition: service_started
        required: true
      redis:
        condition: service_started
        required: true
    environment:
      BULL_AUTH_KEY: ${FIRECRAWL_BULL_AUTH_KEY:-}
      EXTRACT_WORKER_PORT: ${FIRECRAWL_EXTRACT_WORKER_PORT:-3004}
      HOST: 0.0.0.0
      MODEL_NAME: ${FIRECRAWL_LLM_MODEL:-gpt-4o}
      NUM_WORKERS_PER_QUEUE: ${FIRECRAWL_NUM_WORKERS:-8}
      OPENAI_API_KEY: ${OPENROUTER_API_KEY}
      OPENAI_BASE_URL: ${OPENROUTER_BASE_URL}
      PLAYWRIGHT_MICROSERVICE_URL: ${PLAYWRIGHT_MICROSERVICE_URL:-http://playwright-service:3000/scrape}
      PORT: ${FIRECRAWL_INTERNAL_PORT:-3002}
      POSTGRES_DB: ${FIRECRAWL_POSTGRES_DB:-postgres}
      POSTGRES_HOST: ${FIRECRAWL_POSTGRES_HOST:-nuq-postgres}
      POSTGRES_PASSWORD: ${FIRECRAWL_POSTGRES_PASSWORD:-firecrawl}
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${FIRECRAWL_POSTGRES_USER:-firecrawl}
      REDIS_RATE_LIMIT_URL: ${FIRECRAWL_REDIS_URL:-redis://redis:6379}
      REDIS_URL: ${FIRECRAWL_REDIS_URL:-redis://redis:6379}
      USE_DB_AUTHENTICATION: ${USE_DB_AUTHENTICATION:-false}
      WORKER_PORT: ${FIRECRAWL_WORKER_PORT:-3005}
    extra_hosts:
      - host.docker.internal:host-gateway
    healthcheck:
      interval: 10s
      retries: 15
      start_period: 120s
      test:
        - CMD-SHELL
        - nc -z 0.0.0.0 3002 || exit 1
      timeout: 5s
    image: ghcr.io/firecrawl/firecrawl:latest
    labels:
      - traefik.enable=true
      - traefik.http.routers.firecrawl.rule=Host(`firecrawl.${DOMAIN:-localhost}`)
      - traefik.http.routers.firecrawl.entrypoints=web
      - traefik.http.services.firecrawl.loadbalancer.server.port=3002
      - traefik.http.routers.firecrawl-secure.rule=Host(`firecrawl.${DOMAIN:-localhost}`)
      - firecrawl-secure.entrypoints=websecure
      - firecrawl-secure.tls=true
      - traefik.http.routers.firecrawl-secure.tls.certresolver=le
    networks:
      firecrawl-network: null
      traefik-net: null
    restart: always
  meilisearch:
    container_name: chat-meilisearch
    environment:
      MEILI_HOST: ${LIBRECHAT_MEILI_HOST:-http://meilisearch:7700}
      MEILI_MASTER_KEY: ${LIBRECHAT_MEILI_MASTER_KEY}
      MEILI_NO_ANALYTICS: "true"
    image: getmeili/meilisearch:v1.12.3
    networks:
      traefik-net: null
    restart: always
    user: ${UID:-1000}:${GID:-1000}
    volumes:
      - bind:
          create_host_path: true
        source: /home/jumplink/Projekte/faktenforum/ai-chat-interface/meili_data_v1.12
        target: /meili_data
        type: bind
  mongodb:
    command: mongod --noauth
    container_name: chat-mongodb
    image: mongo
    networks:
      traefik-net: null
    restart: always
    user: ${UID:-1000}:${GID:-1000}
    volumes:
      - bind:
          create_host_path: true
        source: /home/jumplink/Projekte/faktenforum/ai-chat-interface/data-node
        target: /data/db
        type: bind
  nuq-postgres:
    container_name: firecrawl-postgres
    environment:
      POSTGRES_DB: ${FIRECRAWL_POSTGRES_DB:-postgres}
      POSTGRES_PASSWORD: ${FIRECRAWL_POSTGRES_PASSWORD:-firecrawl}
      POSTGRES_USER: ${FIRECRAWL_POSTGRES_USER:-firecrawl}
    healthcheck:
      interval: 5s
      retries: 5
      test:
        - CMD-SHELL
        - pg_isready -U ${FIRECRAWL_POSTGRES_USER:-firecrawl} -d ${FIRECRAWL_POSTGRES_DB:-postgres}
      timeout: 5s
    image: ghcr.io/firecrawl/nuq-postgres:latest
    networks:
      firecrawl-network: null
    restart: always
    volumes:
      - source: firecrawl_pgdata
        target: /var/lib/postgresql/data
        type: volume
        volume: {}
  playwright-service:
    container_name: firecrawl-playwright
    environment:
      - PORT=3000
    image: ghcr.io/firecrawl/playwright-service:latest
    networks:
      firecrawl-network: null
      traefik-net: null
    restart: always
    user: root
  rag_api:
    container_name: rag_api
    depends_on:
      vectordb:
        condition: service_started
        required: true
    environment:
      DB_HOST: vectordb
      EMBEDDINGS_MODEL: ${EMBEDDINGS_MODEL:-text-embedding-3-small}
      EMBEDDINGS_PROVIDER: ${EMBEDDINGS_PROVIDER:-openai}
      OPENAI_API_BASE: ${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-${OPENROUTER_API_KEY:-}}
      RAG_OPENAI_API_KEY: ${RAG_OPENAI_API_KEY:-${OPENROUTER_API_KEY:-}}
      RAG_OPENAI_BASEURL: ${RAG_OPENAI_BASEURL:-${OPENROUTER_BASE_URL:-}}
      RAG_PORT: ${LIBRECHAT_RAG_PORT:-8000}
    image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:latest
    networks:
      traefik-net: null
    restart: always
  redis:
    command: redis-server --bind 0.0.0.0
    container_name: firecrawl-redis
    image: redis:alpine
    networks:
      firecrawl-network: null
    restart: always
  searxng:
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    cap_drop:
      - ALL
    container_name: searxng
    environment:
      SEARXNG_BASE_URL: http://searxng.${DOMAIN:-localhost}/
    image: searxng/searxng:latest
    labels:
      - traefik.enable=true
      - traefik.http.routers.searxng.rule=Host(`searxng.${DOMAIN:-localhost}`)
      - traefik.http.routers.searxng.entrypoints=web
      - traefik.http.services.searxng.loadbalancer.server.port=8080
      - traefik.http.routers.searxng-secure.rule=Host(`searxng.${DOMAIN:-localhost}`)
      - traefik.http.routers.searxng-secure.entrypoints=websecure
      - traefik.http.routers.searxng-secure.tls=true
      - traefik.http.routers.searxng-secure.tls.certresolver=le
    logging:
      driver: json-file
      options:
        max-file: "1"
        max-size: 1m
    networks:
      traefik-net: null
    ports:
      - mode: ingress
        protocol: tcp
        published: "8080"
        target: 8080
    restart: always
    volumes:
      - bind:
          create_host_path: true
        source: /home/jumplink/Projekte/faktenforum/ai-chat-interface/searxng
        target: /etc/searxng
        type: bind
  vectordb:
    container_name: vectordb
    environment:
      POSTGRES_DB: ${LIBRECHAT_VECTORDB_DB:-mydatabase}
      POSTGRES_PASSWORD: ${LIBRECHAT_VECTORDB_PASSWORD:-mypassword}
      POSTGRES_USER: ${LIBRECHAT_VECTORDB_USER:-myuser}
    image: pgvector/pgvector:0.8.0-pg15-trixie
    networks:
      traefik-net: null
    restart: always
    volumes:
      - source: pgdata2
        target: /var/lib/postgresql/data
        type: volume
        volume: {}
volumes:
  firecrawl_pgdata:
    name: ai-chat-interface_firecrawl_pgdata
  pgdata2:
    name: ai-chat-interface_pgdata2
